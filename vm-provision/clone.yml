---

- name: Clone a virtual machine on the given ESXi hostname, from the specified template
  vmware_guest:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    datastore: "{{ item.datastore }}"
    validate_certs: no
    datacenter: "{{ item.datacenter_name }}"
    folder: "{{ item.full_folder_path }}"
    name: "{{ item.vm_name }}"
    state: "{{ item.vm_state }}"
    esxi_hostname: "{{ item.host }}"
    hardware:
      memory_mb: "{{ item.memory_mb | default(omit) }}"
      num_cpus: "{{ item.num_cpus | default(omit) }}"
    networks:
    - name: "VM Network"
      mac: 00:50:56:97:e4:b7
    template: "{{ item.vm_template_name }}"
    wait_for_ip_address: no
  delegate_to: localhost
  register: deployed_cloned_vm

- name: Power On the recently created/cloned VM
  vmware_guest:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    datastore: "{{ item.datastore }}"
    validate_certs: no
    name: "{{ item.vm_name }}"
    state: poweredon
  delegate_to: localhost
  register: deployed_cloned_vm_poweron

- name: Wait for system to become reachable over WinRM
  wait_for_connection:
    timeout: 180

vars:
  esxi_login: &esxi_login
    hostname: '{{ host_name }}'
    username: '{{ host_username }}'
    password: '{{ host_password }}'  
    validate_certs: no 

- name: Enable ESX SSH (TSM-SSH)
  vmware_host_service_manager:
    <<: *esxi_login
    esxi_hostname: '{{ host_name }}'
    service_name: TSM-SSH
    state: present
  delegate_to: localhost
- name: Enable ESX Shell (TSM)
  vmware_host_service_manager:
    <<: *esxi_login
    esxi_hostname: '{{ host_name }}'
    service_name: TSM
    state: present
  delegate_to: localhost

- name: Removing VMX Entry - floppy0.fileName = "Floppy drive 1"
  lineinfile:
    path: '/vmfs/volumes/{{ item.datastore }}/{{ item.vm_name }}/{{ item.vm_name }}.vmx'
    line: 'floppy0.fileName = "Floppy drive 1"'
    state: absent
  delegate_to: '{{ item.host }}'
- name: Removing VMX Entry - floppy0.present = "FALSE"
  lineinfile:
    path: '/vmfs/volumes/{{ item.datastore }}/{{ item.vm_name }}/{{ item.vm_name }}.vmx'
    line: 'floppy0.present = "FALSE"'
    state: absent
  delegate_to: '{{ item.host }}'
- name: Adding VMX Entry - floppy0.fileType
  lineinfile:
    path: '/vmfs/volumes/{{ item.datastore }}/{{ item.vm_name }}/{{ item.vm_name }}.vmx'
    line: 'floppy0.fileType = "file"'
  delegate_to: '{{ item.host }}'
- name: Adding VMX Entry - floppy0.fileName
  lineinfile:
    path: '/vmfs/volumes/{{ item.datastore }}/{{ item.vm_name }}/{{ item.vm_name }}.vmx'
    line: 'floppy0.fileName = "/vmfs/volumes/{{ item.datastore  }}/{{ item.host }}.flp"'
  delegate_to: '{{ item.host }}'