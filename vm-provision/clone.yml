---

- name: Clone a virtual machine on the given ESXi hostname, from the specified template
  vmware_guest:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    datastore: "{{ item.datastore }}"
    validate_certs: no
    datacenter: "{{ item.datacenter_name }}"
    folder: "{{ item.full_folder_path }}"
    name: "{{ item.vm_name }}"
    state: "{{ item.vm_state }}"
    esxi_hostname: "{{ item.host }}"
    hardware:
      memory_mb: "{{ item.memory_mb | default(omit) }}"
      num_cpus: "{{ item.num_cpus | default(omit) }}"
    networks:
    - name: "VM Network"
      mac: 00:50:56:97:e4:b7
    template: "{{ item.vm_template_name }}"
    wait_for_ip_address: no
  delegate_to: localhost
  register: deployed_cloned_vm

#- name: Set the state of a virtual machine to poweron
#  vmware_guest_powerstate:
#    hostname: "{{ vcenter_hostname }}"
#    username: "{{ vcenter_username }}"
#    password: "{{ vcenter_password }}"
    #datastore: "{{ item.datastore }}"
    #datacenter: "{{ item.datacenter_name }}"
    #esxi_hostname: "{{ item.host }}"
#    validate_certs: no
#    folder: "{{ item.full_folder_path }}"
#    name: "{{ item.vm_name }}"
#    state: powered-on
    #wait_for_ip_address: no
#  delegate_to: localhost
#  register: deployed_cloned_vm_poweron

- name: Power On the recently created/cloned VM
  vmware_guest:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    datastore: "{{ item.datastore }}"
    validate_certs: no
    name: "{{ item.vm_name }}"
    state: poweredon
  delegate_to: localhost
  register: deployed_cloned_vm_poweron

- name: Wait for system to become reachable over WinRM
  wait_for_connection:
    timeout: 180

- name: Mount Floppy Disk
  mount:
    path: /mnt/floppy
    src: "{{ item.datastore }}/{{ item.host }}.flp"
    fstype: thin
    opts: ro
    state: present

#- name: Mount Floppy Disk
#  vmware_guest:
#    hostname: "{{ vcenter_hostname }}"
#    username: "{{ vcenter_username }}"
#    password: "{{ vcenter_password }}"
#    datastore: "{{ item.datastore }}"
#    validate_certs: no
#    datacenter: "{{ item.datacenter_name }}"
#    folder: "{{ item.full_folder_path }}"
#    name: "{{ item.vm_name }}"
#    state: "{{ item.vm_state }}"
#    esxi_hostname: "{{ item.host }}"
#    disk:
#    - size_gb: '{{ vm_disk_gb }}'
#      type: thin
#      datastore: '{{ esxi_datastore }}'
#  delegate_to: localhost
#  register: deploy_vm