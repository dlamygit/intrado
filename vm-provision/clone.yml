---

- name: Clone a virtual machine on the given ESXi hostname, from the specified template
  vmware_guest:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    datastore: "{{ item.datastore }}"
    validate_certs: no
    datacenter: "{{ item.datacenter_name }}"
    folder: "{{ item.full_folder_path }}"
    name: "{{ item.vm_name }}"
    state: "{{ item.vm_state }}"
    esxi_hostname: "{{ item.host }}"
    hardware:
      memory_mb: "{{ item.memory_mb | default(omit) }}"
      num_cpus: "{{ item.num_cpus | default(omit) }}"
    networks:
    - name: "VM Network"
      mac: 00:50:56:97:e4:b7
    template: "{{ item.vm_template_name }}"
    wait_for_ip_address: no
  delegate_to: localhost
  register: deployed_cloned_vm
  
- name: Change virtual machine's boot order and related parameters
  vmware_guest_boot_manager:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    datastore: "{{ item.datastore }}"
    validate_certs: no
    datacenter: "{{ item.datacenter_name }}"
    folder: "{{ item.full_folder_path }}"
    name: "{{ item.vm_name }}"
    boot_firmware: bios
    boot_order:
      - cdrom
      - disk
      - floppy
  delegate_to: localhost
  register: vm_boot_order

- name: Enable ESX SSH (TSM-SSH)
  vmware_host_service_manager:  
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ host_name }}'
    validate_certs: no
    service_name: TSM-SSH
    state: present
  delegate_to: localhost

- name: Enable ESX Shell (TSM)
  vmware_host_service_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ host_name }}'
    validate_certs: no
    service_name: TSM
    state: present
  delegate_to: localhost



- name: Power On the recently created/cloned VM
  vmware_guest:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    datastore: "{{ item.datastore }}"
    validate_certs: no
    name: "{{ item.vm_name }}"
    state: poweredon
  delegate_to: localhost
  register: deployed_cloned_vm_poweron

#- name: Wait for system to become reachable over WinRM
#  wait_for_connection:
#    delay: 120
#    timeout: 180

